name: Commit Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Analyze Commit with LLM
        env:
          DEMETERICS_API_KEY: ${{ secrets.DEMETERICS_API_KEY }}
        run: |
          # Get repo name from GitHub context
          REPO_NAME="${{ github.event.repository.name }}"

          # Get commit info
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)

          # Get diff (limit to 500 lines to stay within token limits)
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            COMMIT_DIFF=$(git diff HEAD~1 --no-color | head -500)
          else
            COMMIT_DIFF=$(git show --no-color | head -500)
          fi

          # Build system prompt with Demeterics metadata (zero token cost)
          SYSTEM_PROMPT="/// APP: GitHub-Commit-Analysis
/// FLOW: ${REPO_NAME}
/// USER: ${COMMIT_AUTHOR}
/// ENV: production

You are a code review assistant. Analyze the git commit and provide:
1. **Summary**: Brief description of what changed
2. **Risk Assessment**: Any potential bugs, issues, or breaking changes
3. **Security**: Security considerations if applicable
4. **Suggestions**: Improvements or best practices

Be concise and actionable."

          # Build user message
          USER_MSG="Analyze this commit:

Commit: ${COMMIT_SHA:0:7}
Author: ${COMMIT_AUTHOR}
Message: ${COMMIT_MSG}

Diff:
${COMMIT_DIFF}"

          # Use jq to build valid JSON payload
          JSON_PAYLOAD=$(jq -n \
            --arg model "openai/gpt-oss-20b" \
            --arg system "$SYSTEM_PROMPT" \
            --arg user "$USER_MSG" \
            '{
              model: $model,
              messages: [
                {role: "system", content: $system},
                {role: "user", content: $user}
              ],
              temperature: 0.3,
              max_tokens: 1000
            }')

          # Call Demeterics API
          RESPONSE=$(curl -s https://api.demeterics.com/groq/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DEMETERICS_API_KEY" \
            -d "$JSON_PAYLOAD")

          # Check for errors first
          if echo "$RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"')
            echo "::error::LLM API error: $ERROR_MSG"
            echo "Response: $RESPONSE"
            exit 1
          fi

          # Extract analysis from response
          ANALYSIS=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "Analysis failed"')

          # Output to GitHub Step Summary
          echo "## Commit Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${COMMIT_SHA:0:7}\` by ${COMMIT_AUTHOR}" >> $GITHUB_STEP_SUMMARY
          echo "**Message:** ${COMMIT_MSG}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$ANALYSIS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Powered by [Demeterics](https://demeterics.ai) with openai/gpt-oss-20b*" >> $GITHUB_STEP_SUMMARY
