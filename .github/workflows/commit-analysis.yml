name: Commit Analysis

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze PR with LLM
        env:
          DEMETERICS_API_KEY: ${{ secrets.DEMETERICS_API_KEY }}
          REPO_NAME: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          # Get PR info
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # Get diff between base and head (limit to 500 lines)
          # Use || true to prevent SIGPIPE (exit 141) when head closes pipe early
          DIFF=$(git diff "$BASE_SHA"..."$HEAD_SHA" --no-color 2>/dev/null | head -500 || true)

          # Get list of changed files
          FILES_CHANGED=$(git diff "$BASE_SHA"..."$HEAD_SHA" --name-only 2>/dev/null | head -50 || true)

          # Use jq to build valid JSON payload
          JSON_PAYLOAD=$(jq -n \
            --arg model "openai/gpt-oss-20b" \
            --arg repo "$REPO_NAME" \
            --arg author "$PR_AUTHOR" \
            --arg title "$PR_TITLE" \
            --arg files "$FILES_CHANGED" \
            --arg diff "$DIFF" \
            '{
              model: $model,
              messages: [
                {
                  role: "system",
                  content: ("/// APP: GitHub-Commit-Analysis\n/// FLOW: " + $repo + "\n/// USER: " + $author + "\n/// ENV: production\n\nYou are a code review assistant. Analyze this pull request and provide:\n1. Summary: Brief description of what changed\n2. Risk Assessment: Any potential bugs, issues, or breaking changes\n3. Security: Security considerations if applicable\n4. Suggestions: Improvements or best practices\n\nBe concise and actionable. Use markdown formatting.")
                },
                {
                  role: "user",
                  content: ("Analyze this pull request:\n\nTitle: " + $title + "\nAuthor: " + $author + "\n\nFiles changed:\n" + $files + "\n\nDiff:\n" + $diff)
                }
              ],
              temperature: 0.3,
              max_tokens: 1000
            }')

          # Call Demeterics API
          echo "::group::Calling Demeterics API"
          RESPONSE=$(curl -s -w "\n%{http_code}" https://api.demeterics.com/groq/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DEMETERICS_API_KEY" \
            -d "$JSON_PAYLOAD")

          # Extract HTTP status code (last line)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE=$(echo "$RESPONSE" | sed '$d')
          echo "HTTP Status: $HTTP_CODE"
          echo "::endgroup::"

          # Debug: Show response structure (truncated)
          echo "::group::API Response Debug"
          echo "$RESPONSE" | jq -r 'keys' 2>/dev/null || echo "Response is not valid JSON: ${RESPONSE:0:500}"
          echo "::endgroup::"

          # Check for errors first
          if echo "$RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // .error // "Unknown error"')
            echo "::error::LLM API error: $ERROR_MSG"
            exit 1
          fi

          # Check HTTP status
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::API returned HTTP $HTTP_CODE: ${RESPONSE:0:500}"
            exit 1
          fi

          # Extract analysis from response
          ANALYSIS=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

          # Fallback if empty
          if [ -z "$ANALYSIS" ]; then
            echo "::warning::No content in response, showing raw structure"
            ANALYSIS=$(echo "$RESPONSE" | jq -r '.choices // "No choices in response"')
          fi

          # Build comment body using printf to avoid heredoc issues
          COMMENT_BODY=$(printf "## AI Code Review\n\n%s\n\n---\n*Powered by [Demeterics](https://demeterics.ai) with openai/gpt-oss-20b*" "$ANALYSIS")

          # Post comment to PR
          gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY"

          # Also output to Step Summary
          echo "$COMMENT_BODY" >> "$GITHUB_STEP_SUMMARY"
