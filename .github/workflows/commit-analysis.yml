name: Commit Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Analyze Commit with LLM
        env:
          DEMETERICS_API_KEY: ${{ secrets.DEMETERICS_API_KEY }}
          REPO_NAME: ${{ github.event.repository.name }}
          COMMIT_SHA: ${{ github.sha }}
        shell: bash
        run: |
          set -e

          # Get commit info
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)

          # Get diff (limit to 500 lines to stay within token limits)
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            COMMIT_DIFF=$(git diff HEAD~1 --no-color | head -500)
          else
            COMMIT_DIFF=$(git show --no-color | head -500)
          fi

          # Use jq to build valid JSON payload with all escaping handled
          JSON_PAYLOAD=$(jq -n \
            --arg model "openai/gpt-oss-20b" \
            --arg repo "$REPO_NAME" \
            --arg author "$COMMIT_AUTHOR" \
            --arg sha "${COMMIT_SHA:0:7}" \
            --arg msg "$COMMIT_MSG" \
            --arg diff "$COMMIT_DIFF" \
            '{
              model: $model,
              messages: [
                {
                  role: "system",
                  content: ("/// APP: GitHub-Commit-Analysis\n/// FLOW: " + $repo + "\n/// USER: " + $author + "\n/// ENV: production\n\nYou are a code review assistant. Analyze the git commit and provide:\n1. Summary: Brief description of what changed\n2. Risk Assessment: Any potential bugs, issues, or breaking changes\n3. Security: Security considerations if applicable\n4. Suggestions: Improvements or best practices\n\nBe concise and actionable.")
                },
                {
                  role: "user",
                  content: ("Analyze this commit:\n\nCommit: " + $sha + "\nAuthor: " + $author + "\nMessage: " + $msg + "\n\nDiff:\n" + $diff)
                }
              ],
              temperature: 0.3,
              max_tokens: 1000
            }')

          # Call Demeterics API
          RESPONSE=$(curl -s https://api.demeterics.com/groq/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DEMETERICS_API_KEY" \
            -d "$JSON_PAYLOAD")

          # Check for errors first
          if echo "$RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"')
            echo "::error::LLM API error: $ERROR_MSG"
            exit 1
          fi

          # Extract analysis from response
          ANALYSIS=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "Analysis failed"')

          # Output to GitHub Step Summary
          {
            echo "## Commit Analysis"
            echo ""
            echo "**Commit:** \`${COMMIT_SHA:0:7}\` by ${COMMIT_AUTHOR}"
            echo "**Message:** ${COMMIT_MSG}"
            echo ""
            echo "### Analysis"
            echo ""
            echo "$ANALYSIS"
            echo ""
            echo "---"
            echo "*Powered by [Demeterics](https://demeterics.ai) with openai/gpt-oss-20b*"
          } >> "$GITHUB_STEP_SUMMARY"
